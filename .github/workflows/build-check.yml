name: Build Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout ceracoder
        uses: actions/checkout@v4
        with:
          path: ceracoder
          submodules: recursive

      - name: Checkout SRT (dependency)
        uses: actions/checkout@v4
        with:
          repository: CERALIVE/srt
          path: srt

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            libssl-dev \
            pkg-config \
            tclsh \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-base

      - name: Build SRT
        run: |
          cd srt
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DENABLE_APPS=OFF \
            -DENABLE_BONDING=ON \
            -DENABLE_ENCRYPTION=ON
          cmake --build build -j$(nproc)
          sudo cmake --install build

      - name: Build ceracoder
        run: |
          cd ceracoder
          make ceracoder

      - name: Verify binary was built
        run: |
          ls -la ceracoder/ceracoder
          file ceracoder/ceracoder

      - name: Build Summary
        run: |
          echo "## âœ… Build Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** ${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
