name: Build and Release Ceracoder

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        type: choice
        options:
          - stable
          - beta
        default: stable
      release_notes:
        description: "Release notes (what changed in this release)"
        required: false
        type: string
      force_version:
        description: "Override auto-detected version (optional, e.g., 2026.1.0)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  version:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calver.outputs.version }}
      version_tag: ${{ steps.calver.outputs.version_tag }}
      is_beta: ${{ steps.calver.outputs.is_beta }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Calculate CalVer version with beta support
        id: calver
        env:
          RELEASE_TYPE: ${{ github.event.inputs.release_type }}
          FORCE_VERSION: ${{ github.event.inputs.force_version }}
        run: |
          # Get current year and month (no leading zeros for month)
          YEAR=$(date -u +"%Y")
          MONTH=$(date -u +"%-m")  # %-m removes leading zero
          IS_BETA=$([[ "$RELEASE_TYPE" == "beta" ]] && echo "true" || echo "false")
          
          # Check if force_version is provided
          if [ -n "$FORCE_VERSION" ]; then
            VERSION="$FORCE_VERSION"
            echo "ðŸ“Œ Using forced version: $VERSION"
          else
            # Find existing tags for this year.month
            PREFIX="v${YEAR}.${MONTH}"
            
            if [ "$IS_BETA" == "true" ]; then
              # For beta: find highest beta number for this month
              LATEST_BETA=$(git tag -l "${PREFIX}.*-beta.*" | sed -E "s/.*-beta\.([0-9]+)/\1/" | sort -n | tail -1)
              
              if [ -z "$LATEST_BETA" ]; then
                BETA_NUM=1
                echo "ðŸ§ª First beta of ${YEAR}.${MONTH}"
              else
                BETA_NUM=$((LATEST_BETA + 1))
                echo "ðŸ”„ Incrementing beta: ${LATEST_BETA} â†’ ${BETA_NUM}"
              fi
              
              # Get the base patch (latest stable or 0)
              LATEST_STABLE=$(git tag -l "${PREFIX}.*" | grep -v beta | sed "s/${PREFIX}\.//" | sort -n | tail -1)
              PATCH=${LATEST_STABLE:-0}
              NEXT_PATCH=$((PATCH + 1))
              
              VERSION="${YEAR}.${MONTH}.${NEXT_PATCH}-beta.${BETA_NUM}"
            else
              # For stable: find highest patch number (excluding betas)
              LATEST_PATCH=$(git tag -l "${PREFIX}.*" | grep -v beta | sed "s/${PREFIX}\.//" | sort -n | tail -1)
              
              if [ -z "$LATEST_PATCH" ]; then
                PATCH=0
                echo "ðŸ“… First release of ${YEAR}.${MONTH}"
              else
                PATCH=$((LATEST_PATCH + 1))
                echo "ðŸ”„ Incrementing patch: ${LATEST_PATCH} â†’ ${PATCH}"
              fi
              
              VERSION="${YEAR}.${MONTH}.${PATCH}"
            fi
          fi
          
          VERSION_TAG="v${VERSION}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "is_beta=${IS_BETA}" >> $GITHUB_OUTPUT
          
          echo "âœ… Next version: ${VERSION}"
          echo "ðŸ·ï¸  Tag: ${VERSION_TAG}"
          echo "ðŸ§ª Beta: ${IS_BETA}"
      
      - name: Version Summary
        run: |
          echo "## ðŸ·ï¸ Version Calculated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.calver.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.calver.outputs.version_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ steps.calver.outputs.is_beta == 'true' && 'ðŸ§ª Beta' || 'âœ… Stable' }}" >> $GITHUB_STEP_SUMMARY

  build-release:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: version
    strategy:
      matrix:
        include:
          - arch: x86_64
            platform: linux/amd64
            artifact_name: ceracoder-linux-x86_64
          - arch: arm64
            platform: linux/arm64
            artifact_name: ceracoder-linux-arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up QEMU for cross-platform builds
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ceracoder binary
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          outputs: type=local,dest=./build
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Prepare artifact
        run: |
          mkdir -p artifacts
          cp build/usr/bin/ceracoder artifacts/ceracoder
          chmod +x artifacts/ceracoder
          cd artifacts
          tar -czf ${{ matrix.artifact_name }}-v${{ needs.version.outputs.version }}.tar.gz ceracoder
          sha256sum ${{ matrix.artifact_name }}-v${{ needs.version.outputs.version }}.tar.gz > ${{ matrix.artifact_name }}-v${{ needs.version.outputs.version }}.tar.gz.sha256
          # Also create unversioned symlink for convenience
          ln -s ${{ matrix.artifact_name }}-v${{ needs.version.outputs.version }}.tar.gz ${{ matrix.artifact_name }}.tar.gz
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            artifacts/${{ matrix.artifact_name }}.tar.gz
            artifacts/${{ matrix.artifact_name }}.tar.gz.sha256
  
  create-release:
    name: Create Release
    needs: [version, build-release]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Prepare release assets
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name '*.tar.gz' -o -name '*.sha256' \) -exec cp {} release-files/ \;
          ls -lh release-files/
      
      - name: Generate release body
        env:
          VERSION: ${{ needs.version.outputs.version }}
          VERSION_TAG: ${{ needs.version.outputs.version_tag }}
          IS_BETA: ${{ needs.version.outputs.is_beta }}
          RELEASE_NOTES: ${{ github.event.inputs.release_notes }}
        run: |
          # Get the previous tag for changelog
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          # Generate changelog
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG_HEADER="Changes since ${PREV_TAG}:"
            CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges | head -20)
          else
            CHANGELOG_HEADER="Recent commits:"
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges -20)
          fi
          
          DATE=$(date -u +"%Y-%m-%d")
          
          # Build release body
          {
            echo "# Ceracoder ${VERSION_TAG}"
            echo ""
            if [ "$IS_BETA" == "true" ]; then
              echo "> âš ï¸ **This is a beta release.** It may contain bugs or incomplete features. Use in production at your own risk."
              echo ""
            fi
            echo "**Release Date:** ${DATE}"
            echo ""
            echo "## ðŸ“¦ Downloads"
            echo ""
            echo "| Architecture | File |"
            echo "|--------------|------|"
            echo "| x86_64 (amd64) | \`ceracoder-linux-x86_64-v${VERSION}.tar.gz\` |"
            echo "| ARM64 | \`ceracoder-linux-arm64-v${VERSION}.tar.gz\` |"
            echo ""
            echo "SHA256 checksums are provided for verification."
            echo ""
            echo "## ðŸ“ Installation"
            echo ""
            echo "\`\`\`bash"
            echo "# Download and extract"
            echo "tar -xzf ceracoder-linux-*.tar.gz"
            echo "sudo mv ceracoder /usr/local/bin/"
            echo ""
            echo "# Verify installation"
            echo "ceracoder -v"
            echo "\`\`\`"
            echo ""
            echo "## ðŸ“‹ Release Notes"
            echo ""
            echo "${RELEASE_NOTES:-No release notes provided.}"
            echo ""
            echo "## ðŸ”„ What's Changed"
            echo ""
            echo "${CHANGELOG_HEADER}"
            echo ""
            echo "${CHANGELOG}"
            echo ""
            echo "---"
            echo ""
            echo "**Ceracoder** is a fork of [irlserver/belacoder](https://github.com/irlserver/belacoder), itself a fork of [BELABOX/belacoder](https://github.com/BELABOX/belacoder)."
            echo ""
            echo "ðŸ¤– Built with GitHub Actions using CalVer (YYYY.M.patch) versioning"
          } > release-body.md
          
          echo "ðŸ“„ Generated release body:"
          cat release-body.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version.outputs.version_tag }}
          name: Ceracoder ${{ needs.version.outputs.version_tag }}${{ needs.version.outputs.is_beta == 'true' && ' (Beta)' || '' }}
          body_path: release-body.md
          files: release-files/*
          draft: false
          prerelease: ${{ needs.version.outputs.is_beta == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release Summary
        run: |
          echo "## ðŸŽ‰ Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.version.outputs.version_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ needs.version.outputs.is_beta == 'true' && 'ðŸ§ª Beta (Pre-release)' || 'âœ… Stable' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Assets Uploaded:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -1 release-files/ | while read f; do echo "- \`$f\`" >> $GITHUB_STEP_SUMMARY; done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.version.outputs.version_tag }})" >> $GITHUB_STEP_SUMMARY
